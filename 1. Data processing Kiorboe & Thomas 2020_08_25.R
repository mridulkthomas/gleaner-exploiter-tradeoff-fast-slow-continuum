################## 1. Data processing script for Kiorboe & Thomas
# This script cleans and does initial processing for all analyses in the paper "Heterotrophic eukaryotes show a fast-slow continuum, not a gleaner-exploiter trade-off"
# Data files needed for this script can be found at the following DOI: 10.5281/zenodo.4002028
# Source datasets are from Kiorboe & Hirst (2014), Uiterwaal et al. (2018) and Litchman et al. (2007)
# Temperature-correction was done prior to calculations here

# Load packages
library(dplyr)    #version 1.0.2
library(janitor)  #version 2.0.1

### I. Read in primary dataset, perform quality control & process for further analysis

## A. Kiorboe & Hirst dataset
# 1. Simplify column headers
# 2. Fix 2 types of entries that should be NAs: 
#     (i) zeroes in the rate and body size columns are NAs. Fixing this in code
#     (ii) Excel entries such as "#VALUE!" & "#!NUM"
# 3. Create new column indicating source data set
# 4. Remove entries without a correct body mass (entered value is 0)
# 5. Change habitat type from 'Aquatic (pelagic)' to simply 'Aquatic'
# 6. Change taxa entries to group into phyla

khdat <- read.csv('Kiorboe_and_Hirst_dataset_edited_2020_03_21.csv') %>%
  clean_names() %>%
  droplevels() %>%
  mutate(imax_absolute_raw = na_if(imax_absolute_raw, 0),
         fmax_absolute_raw = na_if(fmax_absolute_raw, 0),
         imax_absolute_tempcorr = na_if(imax_absolute_tempcorr, 0),
         fmax_absolute_tempcorr = na_if(fmax_absolute_tempcorr, 0),
         imax_specific_tempcorr = na_if(imax_specific_tempcorr, 0),
         fmax_specific_tempcorr = na_if(fmax_specific_tempcorr, 0)) %>%
  mutate(source_compilation = 'Kiorboe & Hirst 2014') %>%
  filter(., body_mass > 0) 

khdat$habitat <- recode(khdat$habitat, `Aquatic (pelagic)` = 'Aquatic') 
khdat$group <- recode(khdat$group, 
                      Ciliate = 'Ciliates', 
                      Nanoflagellates = 'Other protists',
                      Dinoflagellate = 'Dinoflagellates',
                      Calanoida = 'Crustaceans',
                      Cyclopoida = 'Crustaceans',
                      Euphausiacea = 'Crustaceans',
                      Harpacticoida = 'Crustaceans',
                      Poecilostomatoida = 'Crustaceans',
                      Tunicata = 'Chordates',
                      Tunicates = 'Chordates',
                      Pisces = 'Chordates',
                      Cnidaria = 'Cnidarians',
                      Chaetognatha = 'Chaetognaths',
                      Ctenophore = 'Ctenophores')

## B. FoRAGE dataset
# Consists of a file with the rates and biomass values, and a file with metadata such as taxonomic information
# 
# 1. Simplify and rename some column headers
# 2. Fix 2 types of entries that should be NAs: 
#     (i) zeroes in the rate and body size columns are NAs. Fixing this in code
#     (ii) Excel entries such as "#VALUE!" & "#!NUM"
# 3. Remove entries without a correct body mass (entered value is 0)
# 4. Change habitat type from 'Aquatic (pelagic)' to simply 'Aquatic'
# 5. Remove entries from 'Mixed' habitat type


fordat <- read.csv('FoRAGE_dataset_edited_2020_03_21.csv') %>%
  clean_names() %>%
  # mutate_if(is.factor, list(~na_if(., "#VALUE!"))) %>%
  mutate(temp = na_if(temp, "x")) %>%
  mutate(fmax_absolute_tempcorr = as.numeric(as.character(fmax_absolute_tempcorr)),
         imax_absolute_tempcorr = as.numeric(as.character(imax_absolute_tempcorr)),
         fmax_specific_tempcorr = as.numeric(as.character(fmax_specific_tempcorr)),
         imax_specific_tempcorr = as.numeric(as.character(imax_specific_tempcorr)),
         temp = as.numeric(as.character(temp)),
         imax_absolute_raw = na_if(imax_absolute_raw, 0),
         fmax_absolute_raw = na_if(fmax_absolute_raw, 0),
         imax_specific_raw = na_if(imax_specific_raw, 0),
         fmax_specific_raw = na_if(fmax_specific_raw, 0),
         imax_absolute_tempcorr = na_if(imax_absolute_tempcorr, 0),
         fmax_absolute_tempcorr = na_if(fmax_absolute_tempcorr, 0),
         imax_specific_tempcorr = na_if(imax_specific_tempcorr, 0),
         fmax_specific_tempcorr = na_if(fmax_specific_tempcorr, 0)) %>%
  rename(body_mass = 'predator_mass_mg_fresh') %>%
  filter(., body_mass > 0) %>%
  filter(habitat != 'Mixed') %>%
  droplevels() 
# warnings are not a problem - they are related to replacing unwanted text values with NAs
fordat$habitat <- recode(fordat$habitat, `Aquatic (pelagic)` = 'Aquatic') 

# 6. Read in metadata dataset containing taxonomic information

formetadat <- read.csv('FoRAGE_dataset_taxonomic_info_edited_2020_03_21.csv') %>%
  clean_names() %>%
  rename(group = major_grouping_1) 

# 7. Merge values and metadata
# 8. Create new column indicating source data set
# 9. Exclude one study with poor quality data (see Methods section and FoRAGE paper)

foragedat <- left_join(fordat, formetadat, by = 'dataset_number') %>%
  rename(species = 'predator_scientific_name') %>%
  droplevels() %>%
  mutate(source_compilation = 'FoRAGE dataset') %>%
  filter(source != 'Palanichamy 1983 PROC INDIAN ACAD SCI')
rm(fordat, formetadat)

# 10. Change taxa entries to group into phyla

foragedat$group <- recode(foragedat$group, 
                          Chrysophyte = 'Other protists',
                          Ciliate = 'Ciliates', 
                          Euglenid = 'Other protists', 
                          Sarcodine = 'Other protists',
                          Crustacean = 'Crustaceans',
                          Dinoflagellate = 'Dinoflagellates',
                          Amphibian = 'Chordates',
                          Mammal = 'Chordates',
                          Bird = 'Chordates',
                          Reptile = 'Chordates',
                          Arachnid = 'Arthropods',
                          Insect = 'Arthropods',
                          Cnidarian = 'Cnidarians',
                          Fish = 'Chordates',
                          Mollusk = 'Molluscs',
                          Tardigrade = 'Tardigrades',
                          Rotifer = 'Rotifers',
                          Platyhelminth = 'Platyhelminths',
                          Ctenophore = 'Ctenophores')

## C. Merge Kiorboe & Hirst dataset and FoRAGE dataset

# Checking that column headers match
colnames(foragedat)[!(colnames(foragedat) %in% colnames(khdat))]
colnames(khdat)[!(colnames(khdat) %in% colnames(foragedat))]
# all match

# Identify species present in Kiorboe & Hirst dataset that are also present in Forage dataset. 
# Remove these from Forage dataset before merging. 
foragedat_subset <- anti_join(foragedat, khdat, by = 'species') %>%
  select(-dataset_number)

# Checking if there are still common species.
summary(foragedat_subset$species %in% khdat$species)
foragedat_subset$species[(foragedat_subset$species %in% khdat$species)]
# No. All fine.

# Merging datasets
full_dat <- full_join(khdat, foragedat_subset)

# Recoding habitat dimensionality for ease of plotting and fixing format of factors
full_dat$dimension <- recode(as.factor(full_dat$dimension),
                             `2` = 'Surface feeders',
                             `3` = 'Volume feeders')
full_dat$habitat <- as.factor(full_dat$habitat)
full_dat$species <- as.factor(full_dat$species)
full_dat$group <- as.factor(full_dat$group)
rm(khdat, foragedat, foragedat_subset)

## D. Write processed primary dataset
write.csv(full_dat, 'Merged_and_curated_dataset_Kiorboe&Thomas.csv')

### II. Read in outlier dataset for Appendix figure, perform quality control & 
# process for further analysis

outlierdat <- read.csv('FoRAGE_dataset_with_outliers_raw.csv') %>%
  clean_names() %>%
  filter(., i_absolute != '#DIV/0!' & i_absolute != '#NUM!' & i_absolute != '#VALUE!') %>%
  droplevels() %>%
  mutate(i_absolute = as.numeric(as.character(i_absolute)),
         i_specific = as.numeric(as.character(i_specific)),
         excluded = as.factor(ifelse(i_specific > 10^3, 'excluded', 'retained')))

## Write processed outlier dataset
write.csv(outlierdat, 'FoRAGE_dataset_with_outliers_processed.csv')

### II. Read in growth-ingestion dataset for Appendix figure, 
# perform quality control, change taxa entries to group into phyla & 
# process for further analysis

growthdat <- read.csv('Growth_ingestion_dataset_raw.csv') %>%
  clean_names () %>%
  filter(., specific_growth != '--') %>%
  mutate(specific_growth = as.numeric(as.character(specific_growth))) %>%
  droplevels() 

growthdat$group <- recode(growthdat$group, 
                          Tunicata = 'Chordates',
                          Chaetognatha = 'Chaetognaths',
                          `Nanoflagellates (except dinoflagellates)` = 'Other protists',
                          Calanoida = 'Crustaceans',
                          Cyclopoida = 'Crustaceans',
                          `Other Crustacea` = 'Crustaceans',
                          Pisces = 'Chordates')


## Write processed growth-ingestion dataset
write.csv(growthdat, 'Growth_ingestion_dataset_processed.csv')

