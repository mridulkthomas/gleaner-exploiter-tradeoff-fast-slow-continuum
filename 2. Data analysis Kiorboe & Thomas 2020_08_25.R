################## 2. Data analysis and plotting script for Kiorboe & Thomas
# This script will reproduce all analyses in the paper "Heterotrophic eukaryotes show a fast-slow continuum, not a gleaner-exploiter trade-off"
# Note: Run data processing script before this; it outputs files needed for this script.
# Data files needed for this script can be found at the following DOI: 10.5281/zenodo.4002028

# Load packages
library(dplyr)
library(lmodel2)
library(ggplot2)
library(janitor)
library(lme4)
library(cowplot)
library(MuMIn)
library(pbkrtest)
library(rstanarm)
library(ggtext)
# Also used sjPlot library but did not load because of conflicts with cowplot

options(mc.cores = parallel::detectCores())

# Default plot settings
theme_set(theme_bw(base_size = 24) + 
            theme(panel.grid.major = element_blank(), 
                  panel.grid.minor = element_blank()))

# Colour palette
col_palette1 <- c("#D55E00", "#999999", "#009E73", "#56B4E9", "#CC79A7", "#0072B2")

# Read in datasets
full_dat <- read.csv('Merged_and_curated_dataset_Kiorboe&Thomas.csv')
outlierdat <- read.csv('FoRAGE_dataset_with_outliers_processed.csv') 
growthdat <- read.csv('Growth_ingestion_dataset_processed.csv')
phyto_dat <- read.csv('Litchman_2007_phytoplankton_Vmax_and_affinity_data.csv')

# Note that Cmax is called Fmax in the datasets (the terms are synonymous, see main paper)


##### Figures and models in main text, and associated (supplementary) tables  
# Note: (1) Tables are presented alongside relevant figures. Tables without associated figures are 
#           presented at the end; the order of the tables here therefore is different from that 
#           in the supplementary information.


### Fig. 1 is an illustration with no data, and so is not included here. 

### Fig. 2: The relationships between Cmax, Imax and body mass
# Multiple modelling approaches used for each, results consistent. 

## A. Association between absolute (i.e. not size-corrected) Cmax and Imax

# i. OLS
summary(lm(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr), data = full_dat))

# ii. SMA
lmodel2(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr), data = full_dat)

# iii. Mixed model output
summary(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) +
               (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))

# All provide consistent results. Presenting mixed model output.
# Table S1.
sjPlot::tab_model(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) +
                         (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxabs_fmaxabs <- fixef(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) +
                                      (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))

ranefs_d1_groups <- coef(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) + 
                                (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))$group

# Model R^2
r.squaredGLMM(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) + 
                     (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))


## B. Cmax vs. Body mass

# i. OLS
summary(lm(log10(fmax_absolute_tempcorr) ~ log10(body_mass), data = full_dat))

# ii. SMA
lmodel2(log10(fmax_absolute_tempcorr) ~ log10(body_mass), data = full_dat)

# iii. Mixed model output
summary(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# All provide consistent results. Presenting mixed model output.
# Table S2.
sjPlot::tab_model(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_fmaxabs_size <- fixef(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                                   (1|species) + (log10(body_mass)|group), data = full_dat))
ranefs_a1_groups <- coef(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                                (1|species) + (log10(body_mass)|group), data = full_dat))$group

# Model R^2
r.squaredGLMM(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                     (1|species) + (log10(body_mass)|group), data = full_dat))

## C. Imax vs. Body mass
# i. OLS
summary(lm(log10(imax_absolute_tempcorr) ~ log10(body_mass), data = full_dat))

# ii. SMA
lmodel2(log10(imax_absolute_tempcorr) ~ log10(body_mass), data = full_dat)

# iii. Mixed model
summary(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) + 
               (1|species) + (log10(body_mass)|group), data = full_dat))

# All provide consistent results. Presenting mixed model output. 
# Table S3.
sjPlot::tab_model(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxabs_size <- fixef(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) + 
                                   (1|species) + (log10(body_mass)|group), data = full_dat))
ranefs_b1_groups <- coef(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) + 
                                (1|species) + (log10(body_mass)|group), data = full_dat))$group

# Model R^2
r.squaredGLMM(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) +
                     (1|species) + (log10(body_mass)|group), data = full_dat))

## Plotting

d1 <- 
  ggplot(full_dat, aes(imax_absolute_tempcorr, fmax_absolute_tempcorr)) + 
  geom_point(size = 3, alpha = 0.4, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_d1_groups[,1], slope = ranefs_d1_groups[,2], col = 'grey', alpha = 0.5, size = 0.5) +
  geom_abline(intercept = coefs_imaxabs_fmaxabs[1], slope = coefs_imaxabs_fmaxabs[2], size = 2, alpha = 1) +
  xlab(expression(paste(italic('I')[max], "  (mg.day"^{-1}, ")"))) +
  ylab(expression(paste(italic('C')[max], "  (m"^{2}, "or m"^{3}, ".day"^{-1}, ")")))


a1_lab <- ggplot(full_dat, aes(body_mass, fmax_absolute_tempcorr)) + geom_point(size = 3, alpha = 0.25, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_a1_groups[,1], slope = ranefs_a1_groups[,2], col = 'grey', alpha = 0.5, size = 0.5) +
  geom_abline(intercept = coefs_fmaxabs_size[1], slope = coefs_fmaxabs_size[2], size = 2) +
  ylab(expression(paste(italic('C')[max], "  (m"^{2}, "or m"^{3}, ".day"^{-1}, ")"))) +
  xlab(expression(Body~mass~(mg))) 


b1_lab <- ggplot(full_dat, aes(body_mass, imax_absolute_tempcorr)) + 
  geom_point(size = 3, alpha = 0.4, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_b1_groups[,1], slope = ranefs_b1_groups[,2], col = 'grey', alpha = 0.5, size = 0.5) +
  geom_abline(intercept = coefs_imaxabs_size[1], slope = coefs_imaxabs_size[2], size = 2) +
  ylab(Maximum~ingestion~rate~(mg~.~day^{-1})) +
  ylab(expression(paste(italic('I')[max], "  (mg.day"^{-1}, ")"))) +
  xlab(expression(Body~mass~(mg)))


plot_grid(d1, a1_lab, b1_lab, nrow = 1, labels = 'AUTO', label_size = 34, align = 'hv')

# Save plot
ggsave('Fig. 2. Cmax and Imax vs body mass and each other.pdf', width = 17.8, height = 8.7)


### Fig. 3: The relationships between specific Cmax and specific Imax, 
# accounting for differences between habitats and feeding dimensionality
# Multiple modelling approaches used for each, results consistent. 

## A. specific Cmax vs. specific Imax
# i. OLS
summary(lm(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr), data = full_dat))

# ii. SMA
lmodel2(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr), data = full_dat)

# iii. Mixed model
summary(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) + 
               (1|species) + (log10(imax_specific_tempcorr)|group), data = full_dat))
# Mixed model results in singular fit, so model results cannot be trusted. 
# Investigating instead with Bayesian hierarchical model to address the problem

mod_full_rstanarm <- stan_glmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) + 
                                  (1|species) + (log10(imax_specific_tempcorr)|group), 
                                data = full_dat, 
                                control = list(adapt_delta = 0.99),
                                prior = normal(0, 2.5),
                                prior_intercept = normal(0, 10),
                                prior_aux = exponential(1))

# Details of priors
prior_summary(mod_full_rstanarm)

# Examining coefficients
fixef(mod_full_rstanarm)
coef(mod_full_rstanarm)$group

# Results consistent across all modelling types. Presenting Bayesian model output.
# Table S4.
sjPlot::tab_model(mod_full_rstanarm)

# Extracting model coefficients for subsequent plotting 
coefs_imaxspec_fmaxspec <- fixef(mod_full_rstanarm)
ranefs_c1_groups <- coef(mod_full_rstanarm)$group

# Model R^2
median(bayes_R2(mod_full_rstanarm))
median(bayes_R2(mod_full_rstanarm, re.form = NA))
       
## B. specific Cmax vs. specific Imax, by habitat

# i. OLS
summary(lm(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * habitat, data = full_dat))

# ii. SMA
# skipped because of incompatibility with interaction term

# iii. Mixed model
summary(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * habitat + 
               (1|species) + (log10(imax_specific_tempcorr)|group), 
             data = full_dat))

# Results consistent Presenting mixed model output. 
# Table S11.
sjPlot::tab_model(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * habitat + 
                         (1|species) + (log10(imax_specific_tempcorr)|group), 
                       data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxspec_fmaxspec_hab <- fixef(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * habitat + 
                                            (1|species) + (log10(imax_specific_tempcorr)|group), 
                                          data = full_dat))

# Model R^2
r.squaredGLMM(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * habitat + (1|species) + 
                     (log10(imax_specific_tempcorr)|group), data = full_dat))


## C. specific Cmax vs. specific Imax, by feeding dimensionality

# i. OLS
summary(lm(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * dimension, data = full_dat))

# ii. SMA
# skipped because of incompatibility with interaction term

# iii. Mixed model
summary(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * dimension +
               (1|species) + (log10(imax_specific_tempcorr)|group), data = full_dat))

# Very minor difference between results in (i) and (iii): 
# Interaction term switches from weakly positive (0.15) to essentially zero (-0.008)
# Presenting mixed model output
# Table S12.
sjPlot::tab_model(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * dimension +
                         (1|species) + (log10(imax_specific_tempcorr)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxspec_fmaxspec_dim <- fixef(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * dimension + 
                                            (1|species) + (log10(imax_specific_tempcorr)|group), 
                                          data = full_dat))

# Model R^2
r.squaredGLMM(lmer(log10(fmax_specific_tempcorr) ~ log10(imax_specific_tempcorr) * dimension + (1|species) + 
                     (log10(imax_specific_tempcorr)|group), data = full_dat))


##Plotting

c1 <- ggplot(full_dat, aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + 
  geom_point(size = 3, alpha = 0.4, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^1.6)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_c1_groups[,1], slope = ranefs_c1_groups[,2], col = 'grey', size = 0.5, alpha = 0.5) +
  geom_abline(intercept = coefs_imaxspec_fmaxspec[1], slope = coefs_imaxspec_fmaxspec[2], size = 2) +
  xlab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) + 
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")")))


c2 <- full_dat %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr, col = habitat, group = habitat)) +
  geom_point(size = 3, alpha = 0.4) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^1.6)) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks() +
  geom_abline(intercept = coefs_imaxspec_fmaxspec_hab[1], slope = coefs_imaxspec_fmaxspec_hab[2], col = col_palette1[6], size = 2) +
  geom_abline(intercept = coefs_imaxspec_fmaxspec_hab[1] + coefs_imaxspec_fmaxspec_hab[3],
              slope = coefs_imaxspec_fmaxspec_hab[2] + coefs_imaxspec_fmaxspec_hab[4], col = col_palette1[1], size = 2) +
  xlab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) + 
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")"))) +
  scale_colour_manual(values = c(col_palette1[6], col_palette1[1])) +
  theme(legend.title = element_blank(),
        legend.position = c(.18,.85)) +
  guides(colour = guide_legend(override.aes = list(fill = NA)))

c3 <- full_dat %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr, col = dimension, group = dimension)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^1.6)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_abline(intercept = coefs_imaxspec_fmaxspec_dim[1], slope = coefs_imaxspec_fmaxspec_dim[2], col = 'magenta', size = 2) +
  geom_abline(intercept = coefs_imaxspec_fmaxspec_dim[1] + coefs_imaxspec_fmaxspec_dim[3], 
              slope = coefs_imaxspec_fmaxspec_dim[2] + coefs_imaxspec_fmaxspec_dim[4], col = 'darkgreen', size = 2) +
  xlab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) + 
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")"))) +
  scale_colour_manual(values = c('magenta', 'darkgreen')) + 
  theme(legend.title = element_blank(),
        legend.position = c(.21,.80)) + 
  guides(colour = guide_legend(override.aes = list(fill = NA)))

plot_grid(c1, c2, c3, nrow = 1, labels = 'AUTO', label_size = 34)
ggsave('Fig. 3. Specific Cmax ~ Specific Imax, by habitat and dimension.pdf',
       width = 24, height = 8.7)


### Fig. 4: The relationship between specific growth rate and specific Imax
# Multiple modelling approaches used, results consistent. 

# i. OLS
summary(lm(log10(specific_growth) ~ log10(specific_imax), data = growthdat))

# ii. SMA
lmodel2(log10(specific_growth) ~ log10(specific_imax), data = growthdat)

# iii. Mixed model
# Not attempting mixed model because few groups and insufficient points to be meaningful for most groups

# Results consistent Presenting OLS model output. 
# Table S13.
sjPlot::tab_model(lm(log10(specific_growth) ~ log10(specific_imax), data = growthdat))

## Plotting

growthdat %>%
  filter(., !is.na(specific_growth) & !is.na(specific_imax)) %>%
  ggplot(., aes(specific_imax, specific_growth)) + 
  geom_point(aes(col = group), size = 4, alpha = 0.9) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(0.01, 5)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab(expression(Specific~growth~rate~(day^{-1}))) + 
  xlab(expression(paste("Specific ", italic('I')[max], "  (mg.mg.day"^{-1}, ")"))) +
  theme(legend.title = element_blank(), 
        legend.position = c(.81,.21))

ggsave('Fig. 4. Specific growth rate ~ specific Imax.pdf', 
       width = 8.7, height = 8.7)



##### Figures and tables in Supplementary Information


### Fig. S1: The relationships between Cmax, Imax and body mass, by habitat and feeding dimensionality

# OLS & SMA comparisons are skipped for supplementary figures; we present mixed model results only.

## A. Cmax vs body mass
# Same as Fig. 2B. Not specifying model again here. 

## B. Cmax vs body mass, by habitat

# Presenting mixed model output. 
# Table S7.
sjPlot::tab_model(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) * habitat +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_fmaxabs_size_hab <- fixef(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) * habitat +
                                       (1|species) + (log10(body_mass)|group),
                                     data = full_dat))

## C. Cmax vs body mass, by feeding dimensionality

# Presenting mixed model output. 
# Table S8.
sjPlot::tab_model(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) * dimension +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_fmaxabs_size_dim <- fixef(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) * dimension +
                                       (1|species) + (log10(body_mass)|group), data = full_dat))

## D. Imax vs body mass
# Same as Fig. 2C. Not specifying model again here. 

## E. Imax vs body mass, by habitat

# Presenting mixed model output. 
# Table S9.
sjPlot::tab_model(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) * habitat +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxabs_size_hab <- fixef(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) * habitat +
                                       (1|species) + (log10(body_mass)|group),
                                     data = full_dat))

## F. Imax vs body mass, by feeding dimension

# Presenting mixed model output. 
# Table S10.
sjPlot::tab_model(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) * dimension +
                         (1|species) + (log10(body_mass)|group), data = full_dat))

# Extracting model coefficients for subsequent plotting 
coefs_imaxabs_size_dim <- fixef(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) * dimension +
                                       (1|species) + (log10(body_mass)|group), data = full_dat))

## Plotting

a1 <- ggplot(full_dat, aes(body_mass, fmax_absolute_tempcorr)) + 
  geom_point(size = 3, alpha = 0.25, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_a1_groups[,1], slope = ranefs_a1_groups[,2], col = 'grey', alpha = 0.5, size = 0.5) +
  geom_abline(intercept = coefs_fmaxabs_size[1], slope = coefs_fmaxabs_size[2], size = 2) +
  ylab(expression(paste(italic('C')[max], "  (m"^{2}, "or m"^{3}, ".day"^{-1}, ")"))) +
  xlab('')

a2 <- full_dat %>%
  ggplot(., aes(body_mass, fmax_absolute_tempcorr, col = habitat, group = habitat)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = coefs_fmaxabs_size_hab[1], slope = coefs_fmaxabs_size[2], col = col_palette1[6], size = 2) +
  geom_abline(intercept = coefs_fmaxabs_size_hab[1] + coefs_fmaxabs_size_hab[3], 
              slope = coefs_fmaxabs_size[2] + coefs_fmaxabs_size_hab[4], col = col_palette1[1], size = 2) +
  ylab('') +
  xlab('') +
  scale_colour_manual(values = c(col_palette1[6], col_palette1[1])) + 
  theme(legend.title = element_blank(),
        legend.position = c(.22,.85)) + 
  guides(colour = guide_legend(override.aes = list(fill = NA)))

a3 <- full_dat %>%
  ggplot(., aes(body_mass, fmax_absolute_tempcorr, col = dimension, group = dimension)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = coefs_fmaxabs_size_dim[1], slope = coefs_fmaxabs_size_dim[2], col = 'magenta', size = 2) +
  geom_abline(intercept = coefs_fmaxabs_size_dim[1] + coefs_fmaxabs_size_dim[3], 
              slope = coefs_fmaxabs_size[2] + coefs_fmaxabs_size_hab[4], col = 'darkgreen', size = 2) +
  ylab('') +
  xlab('') +
  scale_colour_manual(values = c('magenta', 'darkgreen')) + 
  theme(legend.title = element_blank(),
        legend.position = c(.26,.85)) + 
  guides(colour = guide_legend(override.aes = list(fill = NA)))

b1 <- ggplot(full_dat, aes(body_mass, imax_absolute_tempcorr)) + 
  geom_point(size = 3, alpha = 0.4, col = 'red') + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = ranefs_b1_groups[,1], slope = ranefs_b1_groups[,2], col = 'grey', alpha = 0.5, size = 0.5) +
  geom_abline(intercept = coefs_imaxabs_size[1], slope = coefs_imaxabs_size[2], size = 2) +
  ylab(expression(paste(italic('I')[max], "  (mg.day"^{-1}, ")"))) +
  xlab('')

b2 <- full_dat %>%
  ggplot(., aes(body_mass, imax_absolute_tempcorr, col = habitat, group = habitat)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = coefs_imaxabs_size_hab[1], slope = coefs_imaxabs_size[2], col = col_palette1[6], size = 2) +
  geom_abline(intercept = coefs_imaxabs_size_hab[1] + coefs_imaxabs_size_hab[3], 
              slope = coefs_imaxabs_size[2] + coefs_imaxabs_size_hab[4], col = col_palette1[1], size = 2) +
  ylab('') +
  xlab(expression(Body~mass~(mg))) + 
  scale_colour_manual(values = c(col_palette1[6], col_palette1[1])) + 
  theme(legend.title = element_blank(),
        legend.position = c(.22,.85)) + 
  guides(colour = guide_legend(override.aes = list(fill = NA)))

b3 <- full_dat %>%
  ggplot(., aes(body_mass, imax_absolute_tempcorr, col = dimension, group = dimension)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^7.5)) + 
  annotation_logticks() +
  geom_abline(intercept = coefs_imaxabs_size_dim[1], slope = coefs_imaxabs_size_dim[2], col = 'magenta', size = 2) +
  geom_abline(intercept = coefs_imaxabs_size_dim[1] + coefs_imaxabs_size_dim[3], 
              slope = coefs_imaxabs_size[2] + coefs_imaxabs_size_hab[4], col = 'darkgreen', size = 2) +
  ylab('') +
  xlab('') +
  scale_colour_manual(values = c('magenta', 'darkgreen')) + 
  theme(legend.title = element_blank(),
        legend.position = c(.26,.85)) + 
  guides(colour = guide_legend(override.aes = list(fill = NA)))

## Plot in grid
plot_grid(a1, a2, a3, b1, b2, b3, nrow = 2, labels = 'AUTO', label_size = 34)
ggsave('Fig. S1. Both absolute rates ~ body mass, by habitat and dimension.pdf', 
       width = 24, height = 15)



### Fig. S2: Second method to assess association between Cmax and Imax while accounting for the confounding effect of body size:
# Residuals from the regressions of Cmax vs body mass, and of Imax vs. body mass, are regressed against each other

# Calculating residuals from regressions of Cmax and Imax vs. body mass, using mixed models
full_dat$imax_resid_size <- residuals(lmer(log10(imax_absolute_tempcorr) ~ log10(body_mass) + 
                                             (1|species) + (log10(body_mass)|group),
                                           data = full_dat, na.action = na.exclude))

full_dat$fmax_resid_size <- residuals(lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) + 
                                             (1|species) + (log10(body_mass)|group), 
                                           data = full_dat, na.action = na.exclude))

# Present model results
# Table S5.
sjPlot::tab_model(lm(full_dat$fmax_resid_size ~ full_dat$imax_resid_size))

# Plotting
full_dat %>%
  ggplot(., aes(imax_resid_size, fmax_resid_size)) + 
  geom_point(size = 3, alpha = 0.3) + 
  ylim(c(- 4, 3.5)) + 
  geom_smooth(method = 'lm') +
  ylab('Residuals from regression of Cmax against body size') +
  xlab('Residuals from regression of Imax against body size')

ggsave('Fig. S2. Residuals from body size regressions against each other.pdf', 
       width = 8.7, height = 8.7)


### Fig. S3: The relationships between specific Cmax and specific Imax, coloured by gurop

# Note: Uses same model as Fig. 3A, so model not specified again here.

c1_groups <- ggplot(full_dat, aes(imax_specific_tempcorr, fmax_specific_tempcorr, col = group, group = group)) +
  geom_point(size = 3, alpha = 0.6) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-8, 10^1.6)) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks() +
  geom_abline(intercept = ranefs_c1_groups[,1], slope = ranefs_c1_groups[,2], col = 'grey', size = 0.5, alpha = 0.5) +
  geom_abline(intercept = coefs_imaxspec_fmaxspec[1], slope = coefs_imaxspec_fmaxspec[2], size = 2, alpha = 1) +
  xlab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) +
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")")))

c1_groups
ggsave('Fig. S3. Specific Cmax vs Specific Imax, coloured by taxonomic group.pdf',
       width = 11.4, height = 8.7)


### Fig. S4: Intraspecific variation in the relationship between specific Cmax and specific Imax

# Using 6 species for which most independent measurements exist in the dataset
species_dat <- filter(full_dat, !is.na(imax_specific_tempcorr) & !is.na(fmax_specific_tempcorr)) 

sps1 <- full_dat %>%
  filter(species == 'Lepomis macrochirus') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), 
                breaks = c(10^0, 10^0.5, 10^1, 10^1.5)) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")"))) +
  xlab('') + 
  ggtitle('Lepomis macrochirus') 

sps2 <- full_dat %>%
  filter(species == 'Xylocoris flavipes') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), 
                breaks = c(10^-3.5, 10^-3, 10^-2.5, 10^-2)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab('') + 
  xlab('') + 
  ggtitle('Xylocoris flavipes')

sps3 <- full_dat %>%
  filter(species == 'Ischnura elegans') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-6.5, 10^-5), 
                breaks = c(10^-6.5, 10^-6, 10^-5.5, 10^-5)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab('') + 
  xlab('') + 
  ggtitle('Ischnura elegans')

sps4 <- full_dat %>%
  filter(species == 'Sander vitreus') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab(expression(paste("Specific ", italic('C')[max], "  (mg.mg"^{-1}, ".day"^{-1}, ")"))) +
  xlab(' ') + 
  ggtitle('Sander vitreus') 

sps5 <- full_dat %>%
  filter(species == 'Scolothrips takahashii') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), limits = c(10^-3, 10^-2), 
                breaks = c(10^-3, 10^-2.5, 10^-2)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), 
                breaks = c(10^-0.5, 10^0)) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  geom_abline(intercept = coefs_imaxspec_fmaxspec[1], slope = coefs_imaxspec_fmaxspec[2]) +
  ylab('') + 
  xlab(expression(Specific~maximum~ingestion~rate~(mg~.~mg^{-1}~.~day^{-1}))) +
  xlab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) + 
  ggtitle('Scolothrips takahashii') 

# Scolothrips shows the only negative intraspecific relationship. Investigating further:
summary(lm(log10(full_dat$fmax_specific_tempcorr[full_dat$species == 'Scolothrips takahashii']) ~ 
             log10(full_dat$imax_specific_tempcorr[full_dat$species == 'Scolothrips takahashii'])))
confint(lm(log10(full_dat$fmax_specific_tempcorr[full_dat$species == 'Scolothrips takahashii']) ~
             log10(full_dat$imax_specific_tempcorr[full_dat$species == 'Scolothrips takahashii'])))
# Weak, non-significant relationship (p = 0.48)

sps6 <- full_dat %>%
  filter(species == 'Notonecta maculata') %>%
  ggplot(., aes(imax_specific_tempcorr, fmax_specific_tempcorr)) + geom_point(alpha = 0.8) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', col = 'black') +
  ylab('') + 
  xlab('') + 
  ggtitle('Notonecta maculata')

# Plot in grid

plot_grid(sps1, sps2, sps3, sps4, sps5, sps6, nrow = 2, align = 'hv', labels = 'AUTO', label_size = 34)
ggsave('Fig. S4. Specific Cmax vs Specific Imax, within species.pdf', width = 24, height = 15)


### Fig. S5: Outliers indicative of data errors that were removed before analysis (see Methods)

o1 <- ggplot(outlierdat, aes(predator_mass_mg, i_absolute, col = excluded)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_colour_manual(values = c('darkblue', 'red')) +
  annotation_logticks() +
  ylab(expression(paste(italic('I')[max], "  (mg.day"^{-1}, ")"))) +
  xlab(expression(Body~mass~(mg))) +
  theme(legend.position = "none")

o2 <- ggplot(outlierdat, aes(predator_mass_mg, i_specific, col = excluded)) + 
  geom_point(size = 3, alpha = 0.4) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_colour_manual(values = c('darkblue', 'red')) +
  annotation_logticks() +
  ylab(expression(paste("Specific ", italic('I')[max], "  (m"^{2}," or ", "m"^{3}, ".mg"^{-1}, ".day"^{-1}, ")"))) + 
  xlab(expression(Body~mass~(mg))) +
  theme(legend.position = "none")

# Plotting
plot_grid(o1, o2, labels = 'AUTO', label_size = 34)
ggsave('Fig. S5. Outliers that were removed.pdf', width = 17.8, height = 9)


### Fig. S6: Specific affinity vs specific Vmax in phytoplankton (data from Litchman et al. 2007)

ggplot(phyto_dat, aes(Vmax, Affinity, col = group)) + 
  geom_point(size = 5, alpha = 0.9) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  annotation_logticks() +
  geom_smooth(method = 'lm', se = F, aes(group = 1), col = 'black') +
  ylab(expression(Specific~affinity~(alpha)~(L~.~mu~mol~C^{-1}~.~day^{-1}))) +
  xlab(expression(Specific~Vmax~(mu~mol~N~.~mu~mol~C^{-1}~.~day^{-1})))

ggsave('Fig. S6. Specific affinity ~ specific Vmax for phytoplankton.pdf', width = 12, height = 8)



#### Table S6 (no associated figure)
# Third method to assess association between Cmax and Imax while accounting for the confounding 
# effect of body size: Including body mass and Imax in a regression predicting Cmax, and assessing 
# the explanatory power of Imax through model comparison

# Generate data subset containing all relevant measurements
dat_method3_reduced <- select(full_dat, c(fmax_absolute_tempcorr, imax_absolute_tempcorr,
                                          body_mass, species, group))
dat_method3_reduced <- dat_method3_reduced[complete.cases(dat_method3_reduced),]

# Fit full model
mod_method3_full <- lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) + log10(body_mass) +
                           (1|species) + (log10(imax_absolute_tempcorr)|group), 
                         data = dat_method3_reduced)

# Fit reduced model omitting Imax term
mod_method3_red1 <- lmer(log10(fmax_absolute_tempcorr) ~ log10(body_mass) +
                           (1|species) + (log10(imax_absolute_tempcorr)|group), 
                         data = dat_method3_reduced)

# Perform model comparison to evaluate explanatory power of Imax
# PBmodcomp(mod_method3_full, mod_method3_red1)
# Convergence errors. PBmodcomp (bootstrap-based method) produces unreliable results.

# Using Kenward-Roger approximation instead:
KRmodcomp(mod_method3_full, mod_method3_red1)
# p = 0.006

# Refitting model to full dataset and presenting output
# Table S6.
sjPlot::tab_model(lmer(log10(fmax_absolute_tempcorr) ~ log10(imax_absolute_tempcorr) + log10(body_mass) +
                         (1|species) + (log10(imax_absolute_tempcorr)|group), data = full_dat))
